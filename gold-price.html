<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="తాజా బంగారం ధరలు: హైదరాబాద్, గల్ఫ్ దేశాలలో 24K, 22K, 18K బంగారం ధరలు - తెలుగులో">
    <meta name="keywords" content="బంగారం ధరలు, 24K బంగారం, 22K బంగారం, 18K బంగారం, హైదరాబాద్, గల్ఫ్ దేశాలు, తెలుగు">
    <title>బంగారం ధరలు - తెలుగులో</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu&family=Ramabhadra&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="../scripts.js" defer></script>
</head>
<body data-category="gold-price" class="flex flex-col min-h-screen">
    <div class="top-wrapper"></div>
    <div class="content-bg flex-1">
        <div class="container mx-auto p-4">
            <main class="main-content">
                <section class="gold-price-section my-8">
                    <h2 class="section-title font-ramabhadra text-2xl text-gray-800 border-b-2 border-blue-500 pb-2">బంగారం ధరలు</h2>
                    <div class="filter-wrapper flex items-center gap-4 mb-4">
                        <div class="flex items-center gap-2">
                            <label for="gold-type-filter" class="font-noto text-gray-700">బంగారం రకం:</label>
                            <select id="gold-type-filter" class="p-2 border border-[#d4af37] rounded bg-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="24K">24K</option>
                                <option value="22K" selected>22K</option>
                                <option value="18K">18K</option>
                            </select>
                        </div>
                    </div>
                    <p class="gold-price-date font-noto text-gray-600 mb-4"><i class="far fa-calendar-alt mr-2"></i> <span id="gold-price-date"></span></p>
                    <div id="loading" class="text-center text-gray-600 mb-4">బంగారం ధరలు లోడ్ అవుతున్నాయి...</div>
                    <h3 class="sub-section-title font-ramabhadra text-lg text-gray-800 border-b border-[#d4af37] pb-2 mb-4">భారతదేశం - హైదరాబాద్ (INR)</h3>
                    <table id="india-table" class="w-full bg-white shadow-md mb-6 hidden">
                        <thead>
                            <tr class="bg-[#d4af37] text-white">
                                <th class="p-3 text-center font-bold font-noto">స్థానం</th>
                                <th class="p-3 text-center font-bold font-noto">1g</th>
                                <th class="p-3 text-center font-bold font-noto">10g</th>
                            </tr>
                        </thead>
                        <tbody id="gold-price-table-body-india"></tbody>
                    </table>
                    <h3 class="sub-section-title font-ramabhadra text-lg text-gray-800 border-b border-[#d4af37] pb-2 mb-4">గల్ఫ్ దేశాలు</h3>
                    <table id="gulf-table" class="w-full bg-white shadow-md mb-6 hidden">
                        <thead>
                            <tr class="bg-[#d4af37] text-white">
                                <th class="p-3 text-center font-bold font-noto">స్థానం</th>
                                <th class="p-3 text-center font-bold font-noto">1g (స్థానిక కరెన్సీ)</th>
                                <th class="p-3 text-center font-bold font-noto">10g (స్థానిక కరెన్సీ)</th>
                                <th class="p-3 text-center font-bold font-noto">1g (INR)</th>
                            </tr>
                        </thead>
                        <tbody id="gold-price-table-body-gulf"></tbody>
                    </table>
                    <h3 class="sub-section-title font-ramabhadra text-lg text-gray-800 border-b border-[#d4af37] pb-2 mb-4">నీడవర్సస్ రోజు వారీ పోలిక</h3>
                    <table id="comparison-table" class="w-full bg-white shadow-md mb-6 hidden">
                        <thead>
                            <tr class="bg-[#d4af37] text-white">
                                <th class="p-3 text-center font-bold font-noto">స్థానం</th>
                                <th class="p-3 text-center font-bold font-noto">నీడవర్సస్ ధర (1g)</th>
                                <th class="p-3 text-center font-bold font-noto">నిన్నటి ధర (1g)</th>
                                <th class="p-3 text-center font-bold font-noto">మార్పు</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table-body"></tbody>
                    </table>
                    <h3 class="sub-section-title font-ramabhadra text-lg text-gray-800 border-b border-[#d4af37] pb-2 mb-4">ధర ట్రెండ్స్</h3>
                    <div class="flex items-center gap-2 mb-4">
                        <label for="trend-location" class="font-noto text-gray-700">స్థానం:</label>
                        <select id="trend-location" class="p-2 border border-[#d4af37] rounded bg-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Hyderabad" selected>Hyderabad</option>
                            <option value="Saudi Arabia">Saudi Arabia</option>
                            <option value="UAE">UAE</option>
                            <option value="Qatar">Qatar</option>
                            <option value="Kuwait">Kuwait</option>
                            <option value="Oman">Oman</option>
                            <option value="Bahrain">Bahrain</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <h4 class="font-noto text-gray-700 mb-2">వారపు ట్రెండ్ (7 రోజులు)</h4>
                        <div id="weekly-trend-error" class="text-center text-gray-600 mb-4 hidden">ట్రెండ్‌ల కోసం తగినంత డేటా లేదు.</div>
                        <canvas id="weekly-trend-chart" class="w-full h-64"></canvas>
                    </div>
                    <div>
                        <h4 class="font-noto text-gray-700 mb-2">మాసపు ట్రెండ్ (11 రోజులు)</h4>
                        <div id="monthly-trend-error" class="text-center text-gray-600 mb-4 hidden">ట్రెండ్‌ల కోసం తగినంత డేటా లేదు.</div>
                        <canvas id="monthly-trend-chart" class="w-full h-64"></canvas>
                    </div>
                </section>
            </main>
        </div>
    </div>
    <div class="footer-wrapper"></div>

    <script>
        // Location mappings
        const LOCATIONS = [
            { name: 'Hyderabad', currency: 'INR', region: 'India' },
            { name: 'Saudi Arabia', currency: 'SAR', region: 'Gulf' },
            { name: 'UAE', currency: 'AED', region: 'Gulf' },
            { name: 'Qatar', currency: 'QAR', region: 'Gulf' },
            { name: 'Kuwait', currency: 'KWD', region: 'Gulf' },
            { name: 'Oman', currency: 'OMR', region: 'Gulf' },
            { name: 'Bahrain', currency: 'BHD', region: 'Gulf' }
        ];

        // Load gold prices and initialize page
        async function loadGoldPrices() {
            // Clear localStorage to avoid stale data
            localStorage.removeItem('goldPrices');

            const indiaTable = document.getElementById('india-table');
            const gulfTable = document.getElementById('gulf-table');
            const indiaTbody = document.getElementById('gold-price-table-body-india');
            const gulfTbody = document.getElementById('gold-price-table-body-gulf');
            const comparisonTable = document.getElementById('comparison-table');
            const comparisonTbody = document.getElementById('comparison-table-body');
            const dateSpan = document.getElementById('gold-price-date');
            const goldTypeFilter = document.getElementById('gold-type-filter');
            const trendLocation = document.getElementById('trend-location');
            const loading = document.getElementById('loading');
            const weeklyTrendError = document.getElementById('weekly-trend-error');
            const monthlyTrendError = document.getElementById('monthly-trend-error');
            let weeklyChart = null;
            let monthlyChart = null;

            try {
                // Fetch and parse CSV
                console.log('Fetching gold prices from CSV...');
                const csvResponse = await fetch('/data/gold_prices.csv');
                if (!csvResponse.ok) throw new Error(`CSV fetch failed: ${csvResponse.status} ${csvResponse.statusText}`);
                const csvText = await csvResponse.text();
                const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                console.log('Parsed CSV data:', parsed.data);

                if (parsed.errors.length > 0 || !parsed.data || parsed.data.length === 0) {
                    throw new Error('Invalid CSV data or parsing error');
                }

                // Validate and map CSV data
                const priceData = parsed.data
                    .map(row => {
                        const price24K = parseFloat(row['24K']);
                        const price22K = parseFloat(row['22K']);
                        const price18K = parseFloat(row['18K']);
                        const inrEquivalent = parseFloat(row.INR_Equivalent);
                        if (isNaN(price24K) || isNaN(price22K) || isNaN(price18K) || isNaN(inrEquivalent)) {
                            console.warn(`Invalid numeric data in row:`, row);
                            return null;
                        }
                        return {
                            Date: row.Date ? row.Date.trim() : new Date().toISOString().split('T')[0],
                            Location: row.Location ? row.Location.trim() : '',
                            Region: row.Region ? row.Region.trim() : '',
                            '24K': price24K.toFixed(2),
                            '22K': price22K.toFixed(2),
                            '18K': price18K.toFixed(2),
                            Currency: row.Currency ? row.Currency.trim() : '',
                            INR_Equivalent: inrEquivalent.toFixed(2)
                        };
                    })
                    .filter(row => row && LOCATIONS.some(loc => loc.name.toLowerCase() === row.Location.toLowerCase() && loc.currency === row.Currency));

                console.log('Mapped priceData:', priceData);

                if (priceData.length === 0) {
                    throw new Error('No valid price data found in CSV');
                }

                // Cache data
                localStorage.setItem('goldPrices', JSON.stringify(priceData));

                // Get unique dates and sort descending
                const uniqueDates = [...new Set(priceData.map(row => row.Date))].sort((a, b) => new Date(b) - new Date(a));
                console.log('Unique dates:', uniqueDates);
                const latestDate = uniqueDates[0];
                dateSpan.textContent = latestDate;

                // Render tables for latest date
                function updateGoldTables(goldType) {
                    const filteredData = priceData.filter(row => row.Date === latestDate);
                    indiaTbody.innerHTML = '';
                    gulfTbody.innerHTML = '';

                    // India table (Hyderabad only)
                    filteredData
                        .filter(row => row.Region === 'India' && row.Location.toLowerCase() === 'hyderabad')
                        .forEach(row => {
                            const tr = document.createElement('tr');
                            tr.className = 'even:bg-[#fff5e6] hover:bg-[#fff9e6]';
                            tr.innerHTML = `
                                <td class="p-3 text-center text-gray-700 font-noto">${row.Location}</td>
                                <td class="p-3 text-center text-gray-700 font-noto">₹${row[goldType]}</td>
                                <td class="p-3 text-center text-gray-700 font-noto">₹${(row[goldType] * 10).toFixed(2)}</td>
                            `;
                            indiaTbody.appendChild(tr);
                        });

                    // Gulf table
                    filteredData
                        .filter(row => row.Region === 'Gulf')
                        .forEach(row => {
                            const tr = document.createElement('tr');
                            tr.className = 'even:bg-[#fff5e6] hover:bg-[#fff9e6]';
                            const priceInLocal = row[goldType];
                            const priceInINR = row.INR_Equivalent;
                            tr.innerHTML = `
                                <td class="p-3 text-center text-gray-700 font-noto">${row.Location}</td>
                                <td class="p-3 text-center text-gray-700 font-noto">${priceInLocal} ${row.Currency}</td>
                                <td class="p-3 text-center text-gray-700 font-noto">${(priceInLocal * 10).toFixed(2)} ${row.Currency}</td>
                                <td class="p-3 text-center text-gray-700 font-noto">₹${priceInINR}</td>
                            `;
                            gulfTbody.appendChild(tr);
                        });
                }

                // Today vs Yesterday comparison
                function updateComparisonTable(goldType) {
                    const today = uniqueDates[0];
                    const yesterday = uniqueDates[1] || null;
                    const todayData = priceData.filter(row => row.Date === today);
                    const yesterdayData = yesterday ? priceData.filter(row => row.Date === yesterday) : [];
                    comparisonTbody.innerHTML = '';

                    LOCATIONS.forEach(loc => {
                        const todayRow = todayData.find(row => row.Location.toLowerCase() === loc.name.toLowerCase());
                        if (todayRow) {
                            const yesterdayRow = yesterdayData.find(row => row.Location.toLowerCase() === loc.name.toLowerCase());
                            const todayPrice = parseFloat(todayRow[goldType]);
                            let change = 'N/A';
                            let changeClass = 'text-gray-600';
                            if (yesterdayRow) {
                                const yesterdayPrice = parseFloat(yesterdayRow[goldType]);
                                change = (todayPrice - yesterdayPrice).toFixed(2);
                                changeClass = change >= 0 ? 'text-green-600' : 'text-red-600';
                            }
                            const tr = document.createElement('tr');
                            tr.className = 'even:bg-[#fff5e6] hover:bg-[#fff9e6]';
                            tr.innerHTML = `
                                <td class="p-3 text-center text-gray-700 font-noto">${loc.name}</td>
                                <td class="p-3 text-center text-gray-700 font-noto">${todayPrice.toFixed(2)} ${loc.currency}</td>
                                <td class="p-3 text-center text-gray-700 font-noto">${yesterdayRow ? parseFloat(yesterdayRow[goldType]).toFixed(2) : 'N/A'} ${loc.currency}</td>
                                <td class="p-3 text-center font-noto ${changeClass}">${change !== 'N/A' ? (change >= 0 ? '+' : '') + change : 'N/A'}</td>
                            `;
                            comparisonTbody.appendChild(tr);
                        }
                    });
                    comparisonTable.classList.remove('hidden');
                }

                // Trend charts
                function updateTrendCharts(location, goldType) {
                    const sevenDaysAgo = new Date(latestDate);
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);
                    const locationData = priceData.filter(row => row.Location.toLowerCase() === location.toLowerCase());
                    console.log(`Location data for ${location}:`, locationData);

                    // Normalize date format
                    const formatDate = date => {
                        const d = new Date(date);
                        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    };

                    // Weekly trend (7 days)
                    const weeklyLabels = [];
                    const weeklyData = [];
                    for (let d = new Date(sevenDaysAgo); d <= new Date(latestDate); d.setDate(d.getDate() + 1)) {
                        const dateStr = formatDate(d);
                        const row = locationData.find(row => row.Date === dateStr);
                        if (row && row[goldType] && !isNaN(parseFloat(row[goldType]))) {
                            weeklyLabels.push(dateStr);
                            weeklyData.push(parseFloat(row[goldType]));
                        } else {
                            console.warn(`No valid data for ${location} on ${dateStr}, goldType: ${goldType}`);
                        }
                    }
                    console.log(`Weekly trend for ${location} (${goldType}):`, { labels: weeklyLabels, data: weeklyData });

                    // Monthly trend (11 days)
                    const monthlyLabels = uniqueDates.slice().reverse().slice(0, 11);
                    const monthlyData = monthlyLabels.map(date => {
                        const row = locationData.find(row => row.Date === date);
                        if (row && row[goldType] && !isNaN(parseFloat(row[goldType]))) {
                            return parseFloat(row[goldType]);
                        }
                        console.warn(`No valid data for ${location} on ${date}, goldType: ${goldType}`);
                        return null;
                    }).filter(val => val !== null);
                    console.log(`Monthly trend for ${location} (${goldType}):`, { labels: monthlyLabels, data: monthlyData });

                    // Validate canvases
                    const weeklyCanvas = document.getElementById('weekly-trend-chart');
                    const monthlyCanvas = document.getElementById('monthly-trend-chart');
                    if (!weeklyCanvas || !monthlyCanvas) {
                        console.error('Chart canvases not found');
                        return;
                    }

                    // Destroy existing charts
                    if (weeklyChart) {
                        weeklyChart.destroy();
                        weeklyChart = null;
                    }
                    if (monthlyChart) {
                        monthlyChart.destroy();
                        monthlyChart = null;
                    }

                    // Weekly chart
                    if (weeklyData.length >= 1) {
                        weeklyTrendError.classList.add('hidden');
                        weeklyChart = new Chart(weeklyCanvas, {
                            type: 'line',
                            data: {
                                labels: weeklyLabels,
                                datasets: [{
                                    label: `${goldType} Price (${locationData[0].Currency}/g)`,
                                    data: weeklyData,
                                    borderColor: '#d4af37',
                                    fill: false,
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: { title: { display: true, text: 'తేదీ' } },
                                    y: { title: { display: true, text: `ధర (${locationData[0].Currency}/g)` } }
                                }
                            }
                        });
                    } else {
                        weeklyTrendError.classList.remove('hidden');
                        console.warn('Insufficient data for weekly chart');
                    }

                    // Monthly chart
                    if (monthlyData.length >= 1) {
                        monthlyTrendError.classList.add('hidden');
                        monthlyChart = new Chart(monthlyCanvas, {
                            type: 'line',
                            data: {
                                labels: monthlyLabels.slice(0, monthlyData.length),
                                datasets: [{
                                    label: `${goldType} Price (${locationData[0].Currency}/g)`,
                                    data: monthlyData,
                                    borderColor: '#d4af37',
                                    fill: false,
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: { title: { display: true, text: 'తేదీ' } },
                                    y: { title: { display: true, text: `ధర (${locationData[0].Currency}/g)` } }
                                }
                            }
                        });
                    } else {
                        monthlyTrendError.classList.remove('hidden');
                        console.warn('Insufficient data for monthly chart');
                    }
                }

                // Event listeners
                goldTypeFilter.addEventListener('change', () => {
                    updateGoldTables(goldTypeFilter.value);
                    updateComparisonTable(goldTypeFilter.value);
                    updateTrendCharts(trendLocation.value, goldTypeFilter.value);
                });
                trendLocation.addEventListener('change', () => {
                    updateTrendCharts(trendLocation.value, goldTypeFilter.value);
                });

                // Initial render
                loading.classList.add('hidden');
                indiaTable.classList.remove('hidden');
                gulfTable.classList.remove('hidden');
                updateGoldTables(goldTypeFilter.value);
                updateComparisonTable(goldTypeFilter.value);
                updateTrendCharts(trendLocation.value, goldTypeFilter.value);

                // Auto-refresh every 5 minutes
                setTimeout(loadGoldPrices, 300 * 1000);
            } catch (err) {
                console.error('Error fetching gold prices:', err.message);
                loading.classList.add('hidden');

                // Try cached data
                const cached = localStorage.getItem('goldPrices');
                if (cached) {
                    try {
                        const priceData = JSON.parse(cached);
                        if (Array.isArray(priceData) && priceData.length > 0) {
                            console.log('Using cached gold prices:', priceData);
                            const uniqueDates = [...new Set(priceData.map(row => row.Date))].sort((a, b) => new Date(b) - new Date(a));
                            const latestDate = uniqueDates[0];
                            dateSpan.textContent = latestDate;
                            updateGoldTables(goldTypeFilter.value);
                            updateComparisonTable(goldTypeFilter.value);
                            updateTrendCharts(trendLocation.value, goldTypeFilter.value);
                            indiaTable.classList.remove('hidden');
                            gulfTable.classList.remove('hidden');
                            comparisonTable.classList.remove('hidden');
                            return;
                        }
                    } catch (cacheErr) {
                        console.error('Error parsing cached data:', cacheErr.message);
                    }
                }

                // No data available
                console.log('No valid gold price data available');
            }
        }

        // Run on page load
        window.addEventListener('load', loadGoldPrices);
    </script>
</body>
</html>
