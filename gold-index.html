<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gulf Andhra - News & Gold Prices</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex flex-col min-h-screen">
  <!-- Header -->
  <header class="ticker-marquee">
    <marquee scrollamount="6">Welcome Gulf Andhra • Gold Prices • Exchange Rates</marquee>
  </header>

  <main class="content-bg flex-1">
    <div class="container mx-auto p-4">
      <!-- Featured News Section -->
      <section class="featured-news">
        <h2 class="section-title font-ramabhadra text-2xl text-gray-800 border-b-2 border-blue-500 pb-2">Featured News</h2>
        <div class="featured-news-grid">
          <!-- News cards as per existing styles -->
        </div>
      </section>

      <!-- Gold Price Section -->
      <section class="gold-price-section my-8">
        <h2 class="section-title font-ramabhadra text-2xl text-gray-800 border-b-2 border-blue-500 pb-2">Gold Prices</h2>
        <div class="filter-wrapper flex items-center gap-2 mb-4">
          <label for="location-filter" class="font-noto text-gray-700">Filter by Location:</label>
          <select id="location-filter" class="p-2 border border-[#d4af37] rounded bg-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="all">All Locations</option>
          </select>
        </div>
        <div id="loading" class="text-center text-gray-600">Loading gold prices...</div>
        <div id="error" class="text-center text-red-600 hidden">Error loading gold prices. Please try again later.</div>
        <table id="gold-price-table" class="gold-price-table w-full bg-white shadow-md hidden">
          <thead>
            <tr class="bg-[#d4af37] text-white">
              <th class="p-3 text-center font-bold cursor-pointer" data-sort="Date">Date</th>
              <th class="p-3 text-center font-bold cursor-pointer" data-sort="Location">Location</th>
              <th class="p-3 text-center font-bold cursor-pointer" data-sort="24K">24K</th>
              <th class="p-3 text-center font-bold cursor-pointer" data-sort="22K">22K</th>
              <th class="p-3 text-center font-bold cursor-pointer" data-sort="18K">18K</th>
              <th class="p-3 text-center font-bold cursor-pointer" data-sort="Exchange Price">Exchange Price</th>
              <th class="p-3 text-center font-bold cursor-pointer" data-sort="Currency">Currency</th>
            </tr>
          </thead>
          <tbody id="gold-price-body"></tbody>
        </table>
      </section>

      <!-- Latest News Section -->
      <section class="latest-news">
        <h2 class="section-title font-ramabhadra text-2xl text-gray-800 border-b-2 border-blue-500 pb-2">Latest News</h2>
        <div class="latest-news-grid">
          <!-- News cards as per existing styles -->
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer-wrapper bg-gray-800 text-white p-4 text-center">
    <p>&copy; 2025 Gulf Andhra. All rights reserved.</p>
  </footer>

  <script>
    // GoldAPI.io token
    const GOLD_API_TOKEN = 'goldapi-5tnfsmab0v3ss-io';

    // Location and currency mappings from Excel
    const LOCATIONS = [
      { name: 'Hyderabad', currency: 'INR', exchangeRate: 1 },
      { name: 'Vijayawada', currency: 'INR', exchangeRate: 1 },
      { name: 'Vizag', currency: 'INR', exchangeRate: 1 },
      { name: 'Tirupati', currency: 'INR', exchangeRate: 1 },
      { name: 'Saudi Arabia', currency: 'SAR', exchangeRate: 22.56 },
      { name: 'UAE', currency: 'AED', exchangeRate: 23.07 },
      { name: 'Qatar', currency: 'QAR', exchangeRate: 23.21 },
      { name: 'Kuwait', currency: 'KWD', exchangeRate: 275.91 },
      { name: 'Oman', currency: 'OMR', exchangeRate: 219.83 },
      { name: 'Bahrain', currency: 'BHD', exchangeRate: 223.4281 }
    ];

    // Load gold prices from GoldAPI.io
    async function loadGoldPrices() {
      const table = document.getElementById('gold-price-table');
      const tbody = document.getElementById('gold-price-body');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const locationFilter = document.getElementById('location-filter');

      try {
        // Fetch gold price in USD
        const response = await fetch('https://www.goldapi.io/api/XAU/USD', {
          headers: { 'x-access-token': GOLD_API_TOKEN }
        });
        if (!response.ok) throw new Error('API request failed');
        const data = await response.json();

        const pricePerOunce = data.price; // USD per troy ounce
        const pricePerGram = pricePerOunce / 31.1035; // USD per gram
        const date = new Date(data.timestamp * 1000).toISOString().split('T')[0];

        // Generate price data for each location
        const priceData = LOCATIONS.map(location => ({
          Date: date,
          Location: location.name,
          '24K': (pricePerGram / location.exchangeRate).toFixed(2),
          '22K': ((pricePerGram * 0.9167) / location.exchangeRate).toFixed(2),
          '18K': ((pricePerGram * 0.75) / location.exchangeRate).toFixed(2),
          'Exchange Price': location.exchangeRate.toFixed(4),
          Currency: location.currency
        }));

        // Cache data
        localStorage.setItem('goldPrices', JSON.stringify(priceData));

        // Populate filter dropdown
        locationFilter.innerHTML = '<option value="all">All Locations</option>';
        LOCATIONS.forEach(loc => {
          const option = document.createElement('option');
          option.value = loc.name;
          option.textContent = loc.name;
          locationFilter.appendChild(option);
        });

        // Render table
        const renderTable = (filteredData) => {
          tbody.innerHTML = '';
          filteredData.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'even:bg-[#fff5e6] hover:bg-[#fff9e6]';
            tr.innerHTML = `
              <td class="p-3 text-center text-gray-700 font-noto">${row.Date}</td>
              <td class="p-3 text-center text-gray-700 font-noto">${row.Location}</td>
              <td class="p-3 text-center text-gray-700 font-noto">${row['24K']}</td>
              <td class="p-3 text-center text-gray-700 font-noto">${row['22K']}</td>
              <td class="p-3 text-center text-gray-700 font-noto">${row['18K']}</td>
              <td class="p-3 text-center text-gray-700 font-noto">${row['Exchange Price']}</td>
              <td class="p-3 text-center text-gray-700 font-noto">${row.Currency}</td>
            `;
            tbody.appendChild(tr);
          });
        };

        // Filter logic
        locationFilter.addEventListener('change', () => {
          const value = locationFilter.value;
          const filtered = value === 'all' ? priceData : priceData.filter(row => row.Location === value);
          renderTable(filtered);
        });

        // Sorting logic
        let sortDirection = {};
        document.querySelectorAll('th[data-sort]').forEach(th => {
          th.addEventListener('click', () => {
            const key = th.dataset.sort;
            sortDirection[key] = !sortDirection[key];
            const sorted = [...priceData].sort((a, b) => {
              const aVal = a[key] || '';
              const bVal = b[key] || '';
              if (key.includes('K') || key === 'Exchange Price') {
                return sortDirection[key] ? parseFloat(aVal) - parseFloat(bVal) : parseFloat(bVal) - parseFloat(aVal);
              }
              return sortDirection[key] ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });
            renderTable(sorted);
          });
        });

        // Initial render
        loading.classList.add('hidden');
        table.classList.remove('hidden');
        renderTable(priceData);

        // Auto-refresh every 1 minute
        setTimeout(loadGoldPrices, 60 * 1000);
      } catch (err) {
        console.error('Error fetching gold prices:', err);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        // Fallback to cached data
        const cached = localStorage.getItem('goldPrices');
        if (cached) {
          renderTable(JSON.parse(cached));
          table.classList.remove('hidden');
        }
      }
    }

    // Run on page load
    window.addEventListener('load', loadGoldPrices);

    // Ticker speed adjustment
    function adjustMarqueeSpeed() {
      const marquee = document.querySelector('.ticker-marquee marquee');
      if (!marquee) { console.error('Marquee element not found'); return; }
      const isMobile = window.innerWidth <= 768;
      marquee.setAttribute('scrollamount', isMobile ? '3' : '6');
      marquee.stop();
      setTimeout(() => marquee.start(), 0);
    }
    window.addEventListener('load', adjustMarqueeSpeed);
    window.addEventListener('resize', adjustMarqueeSpeed);
  </script>
</body>
</html>
